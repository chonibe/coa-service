<!-- 5952369e-d399-4cfd-8b45-f703134bb0d9 8559068c-822b-403a-86de-49a888355f61 -->
# Marketplace Login Architecture Refresh

## Goals

- Deliver a streamlined sign-in funnel that recognizes admins vs vendors automatically and exposes clear onboarding/denial paths for unapproved users.
- Provide purpose-built experiences for each persona: marketplace operators (admins) and vendors, with consistent cookie/session semantics.
- Introduce an admin control center toggle for impersonation and tracking vendor context.

## Implementation Strategy

1. **Domain Model & Permissions**

- Define user roles in Supabase (`admins`, `vendors`, `pending_vendors`) with explicit mapping to Supabase auth users.
- Maintain vendor manifest table with status (`active`, `pending`, `suspended`) and metadata for dashboards.

2. **Authentication Funnel**

- Replace `/login` with Experience Selector:
- Primary CTA: `Continue with Google` (Supabase OAuth).
- Secondary CTA: `Sign in with Email` (Supabase email/password).
- Tertiary link: `Request Vendor Access` (forms submission, optional for backlog).
- Collapse legacy login URLs (`/admin/login`, `/vendor/login`, etc.) into redirects pointing at the new funnel so only one entry point exists.
- Add optional passwordless email link (magic link) support for vendors on request.

3. **Callback Routing Logic**

- Centralize in `/app/auth/callback`:
- Normalize email â†’ lookup role assignments.
- If admin: set `admin_session`, clear vendor context, redirect `/admin/dashboard`.
- If vendor (active): set `vendor_session`, redirect `/vendor/dashboard`.
- If vendor pending: show `/vendor/access-pending` page with help text.
- If unmatched: show `/login` with support contact.

4. **Session Middleware**

- Enforce admin pages require `admin_session`.
- Vendor pages require `vendor_session` + vendor status active (middleware + API guards).
- Shared API helper for retrieving vendor name from session (and fail fast).

5. **Admin Experience Enhancements**

- Admin shell includes explicit toggle (tab set) for `Admin Dashboard` and `Vendor Explorer`.
- Vendor Explorer lists vendors, statuses, revenue cards; includes impersonate action (POST `/api/auth/impersonate`).
- Add `Admin banner` to vendor dashboard when impersonating.

6. **Vendor Experience Enhancements**

- Vendor dashboard shows confirmation toast if impersonated vs self.
- Add `/vendor/access-pending` and `/vendor/access-denied` pages for clarity on account state.

7. **Email Notifications (optional)**

- Trigger welcome email when vendor first linked.
- Trigger admin notification when unrecognized vendor attempts login.

8. **Telemetry & Audit**

- Log vendor impersonations (admin + vendor + timestamp).
- Capture failed login attempts for unrecognized emails.

## Deliverables

- Updated Supabase schema migrations for role mapping.
- Revised login UI at `/login` with tiered CTAs.
- New pending-access pages for vendors.
- Hardened callback logic & session middleware.
- Enhanced admin dashboard with toggle + auditor features.
- Documentation update (`docs/features/vendor-login`, `docs/features/admin-portal`).

## Implementation Checklist

IMPLEMENTATION CHECKLIST:

1. Update Supabase schema & seed data with role mapping and vendor status fields.
2. Rebuild `/login` page with Google + email flows, pending request link, and improved UX copy.
3. Refactor `/app/auth/callback` to enforce role-based routing & pending vendor handling.
4. Implement session middleware/guards ensuring admins and vendors hit correct dashboards.
5. Enhance admin dashboard shell with admin/vendor tabs, impersonation audit logs, and vendor explorer.
6. Implement vendor pending/denied pages and impersonation banner on vendor dashboard.
7. Add audit logging for impersonation and failed vendor logins.
8. Update documentation and run manual QA across admin, vendor, pending vendor, and unregistered scenarios.

### To-dos

- [ ] Compose consolidated login flow plan in `docs/features/vendor-login/vendor.plan.md` with sections covering landing, OAuth, callbacks, admin impersonation, logout.
- [ ] Add Supabase role mapping & vendor status fields; seed admin/vendor entries.
- [ ] Rebuild `/login` UX with Google/email CTAs and access request link.
- [ ] Refactor `/app/auth/callback` for role-based routing + pending vendor handling.
- [ ] Implement robust middleware/guards for admin and vendor areas.
- [ ] Add admin toggle, vendor explorer, and impersonation auditing to admin UI.
- [ ] Add impersonation banner and pending/denied access pages for vendors.
- [ ] Log impersonation events, failed logins, and optionally notify admins.
- [ ] Update documentation and conduct full manual QA across roles.